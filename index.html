<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#001a33">
    <meta name="description" content="Checklist Volpini PRO v5">
    <title>Checklist Volpini v5.0 Final</title>
    
    <!-- Script PDF (Vers√£o Est√°vel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --gold: #d4af37;
            --dark: #001a33;
            --light: #f5f5f5;
            --text: #333;
            --success: #27ae60;
            --error: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: var(--light);
            color: var(--text);
            padding: 20px;
        }

        /* --- CONTAINER --- */
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER --- */
        .header {
            background: linear-gradient(135deg, #001a33 0%, #002b55 100%);
            color: var(--gold);
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 4px solid var(--gold);
        }

        .logo-container {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 12px;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-container img { width: 100%; height: 100%; object-fit: contain; }

        .header-content h1 { 
            font-size: 26px; 
            font-weight: 800; 
            text-transform: uppercase; 
            margin-bottom: 5px; 
            color: white;
        }
        
        .contact-info {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        /* --- STATUS --- */
        .status-badge {
            margin-left: auto; /* Empurra para direita */
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .blink-dot {
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--success);
            animation: pulse 1.5s infinite;
        }
        
        .blink-dot.offline { background-color: var(--error); animation: none; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* --- TABS --- */
        .tabs {
            display: flex;
            background: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }

        .tab-btn {
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 700;
            color: #555;
            flex: 1;
            transition: 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: white;
            color: var(--dark);
            border-bottom-color: var(--gold);
        }

        /* --- FORMUL√ÅRIO --- */
        .content-area { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeEffect 0.3s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        .section-title {
            background-color: var(--dark);
            color: var(--gold);
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 14px;
            margin: 20px 0 10px 0;
            text-transform: uppercase;
        }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .full { grid-template-columns: 1fr; }

        .form-group { display: flex; flex-direction: column; }
        
        label { font-weight: 700; margin-bottom: 4px; color: #444; font-size: 12px; }

        input, select, textarea {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            background: #fff;
            color: #000;
        }

        input:focus { border-color: var(--gold); outline: none; }

        /* --- CATEGORIAS DETALHADAS --- */
        .equip-section {
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fcfcfc;
            page-break-inside: avoid; /* Importante para PDF */
        }

        .equip-title {
            font-size: 12px;
            font-weight: 800;
            color: var(--dark);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 4px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .cb-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--gold); }

        /* --- BOT√ïES --- */
        .btn-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 13px;
        }

        .btn-primary { background-color: var(--gold); color: var(--dark); }
        .btn-pdf { background-color: var(--dark); color: white; }
        .btn-clear { background-color: #eee; color: #555; }

        /* --- HIST√ìRICO --- */
        .history-card {
            background: white;
            border: 1px solid #ddd;
            border-left: 4px solid var(--gold);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- AJUSTES PDF CR√çTICOS --- */
        body.generating-pdf .hide-on-pdf { display: none !important; }
        
        body.generating-pdf .container {
            width: 800px !important; /* Largura fixa A4 */
            max-width: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        /* Garante contraste m√°ximo no PDF */
        body.generating-pdf input, 
        body.generating-pdf select, 
        body.generating-pdf textarea {
            border: 1px solid #999 !important;
            background: #fff !important;
            color: #000 !important;
        }
        
        body.generating-pdf .section-title {
            background-color: #eee !important;
            color: #000 !important;
            border: 1px solid #000 !important;
        }

        body.generating-pdf .header {
            background: #001a33 !important; /* Cor s√≥lida para garantir */
            -webkit-print-color-adjust: exact;
        }

        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .status-badge { margin: 10px auto 0 auto; }
            .row { grid-template-columns: 1fr; }
            .checkbox-group { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div class="container" id="app">
        <!-- HEADER -->
        <div class="header">
            <div class="logo-container">
                <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/bbac6cb8-036e-4ce1-852d-e6c3397ecc20" alt="Logo" crossorigin="anonymous">
            </div>
            <div class="header-content">
                <h1>Checklist de Oficina</h1>
                <p>Inspe√ß√£o T√©cnica Veicular - Volpini</p>
                <div class="contact-info">
                    <span>üìç R. D, 101 - Jardim Vera Cruz, Contagem - MG</span>
                    <span>üìû (31) 99331-0800</span>
                </div>
            </div>
            <div class="status-badge hide-on-pdf">
                <div class="blink-dot" id="connectionDot"></div>
                <span id="connectionText">ONLINE</span>
            </div>
        </div>

        <!-- ABAS -->
        <div class="tabs hide-on-pdf">
            <button class="tab-btn active" onclick="switchTab('tab-novo')">‚ûï NOVO CHECKLIST</button>
            <button class="tab-btn" onclick="switchTab('tab-historico')">üìã HIST√ìRICO</button>
        </div>

        <!-- CONTE√öDO: NOVO -->
        <div id="tab-novo" class="tab-content active content-area">
            <form id="checklistForm">
                
                <!-- DADOS CLIENTE -->
                <div class="section-title">üë§ CLIENTE</div>
                <div class="row">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="cliente_nome" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone / WhatsApp</label>
                        <input type="tel" id="cliente_tel">
                    </div>
                </div>
                <div class="row full">
                    <div class="form-group">
                        <label>Endere√ßo Completo</label>
                        <input type="text" id="cliente_end">
                    </div>
                </div>

                <!-- DADOS VE√çCULO -->
                <div class="section-title">üöó VE√çCULO</div>
                <div class="row">
                    <div class="form-group">
                        <label>Placa *</label>
                        <input type="text" id="veiculo_placa" placeholder="ABC-1234" maxlength="8" style="text-transform: uppercase; font-weight: bold;" required>
                    </div>
                    <div class="form-group">
                        <label>Modelo / Marca</label>
                        <input type="text" id="veiculo_modelo">
                    </div>
                </div>
                <div class="row three">
                    <div class="form-group">
                        <label>KM</label>
                        <input type="number" id="veiculo_km">
                    </div>
                    <div class="form-group">
                        <label>Combust√≠vel</label>
                        <select id="veiculo_combustivel">
                            <option value="">Selecione...</option>
                            <option value="Reserva">Reserva</option>
                            <option value="1/4">1/4</option>
                            <option value="1/2">Meio</option>
                            <option value="3/4">3/4</option>
                            <option value="Cheio">Cheio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="data_entrada">
                    </div>
                </div>

                <!-- CATEGORIAS DETALHADAS -->
                <div class="section-title">üîß VISTORIA COMPLETA</div>

                <div class="equip-section">
                    <div class="equip-title">Acess√≥rios Obrigat√≥rios</div>
                    <div class="checkbox-group">
                        <div class="cb-item"><input type="checkbox" name="item" value="Estepe"><label>Estepe</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Macaco"><label>Macaco</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Chave Roda"><label>Chave Roda</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Tri√¢ngulo"><label>Tri√¢ngulo</label></div>
                    </div>
                </div>

                <div class="equip-section">
                    <div class="equip-title">Tipo de Combust√≠vel</div>
                    <div class="checkbox-group">
                        <div class="cb-item"><input type="checkbox" name="item" value="Gasolina"><label>Gasolina</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Etanol"><label>Etanol</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Flex"><label>Flex</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="GNV"><label>GNV</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Diesel"><label>Diesel</label></div>
                    </div>
                </div>

                <div class="equip-section">
                    <div class="equip-title">Eletr√¥nicos & El√©tricos</div>
                    <div class="checkbox-group">
                        <div class="cb-item"><input type="checkbox" name="item" value="R√°dio/Multim√≠dia"><label>R√°dio/Som</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Alarme"><label>Alarme</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Vidro El√©trico"><label>Vidro El√©t.</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Trava El√©trica"><label>Trava El√©t.</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Buzina"><label>Buzina</label></div>
                    </div>
                </div>

                <div class="equip-section">
                    <div class="equip-title">Rodas & Diversos</div>
                    <div class="checkbox-group">
                        <div class="cb-item"><input type="checkbox" name="item" value="Calotas"><label>Calotas</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Rodas Liga"><label>Rodas Liga</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Extintor"><label>Extintor</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Documento"><label>Documento</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Tapetes"><label>Tapetes</label></div>
                    </div>
                </div>
                
                <div class="equip-section">
                    <div class="equip-title">Mec√¢nica / Transmiss√£o</div>
                    <div class="checkbox-group">
                        <div class="cb-item"><input type="checkbox" name="item" value="C√¢mbio Autom√°tico"><label>Autom√°tico</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="C√¢mbio Manual"><label>Manual</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="4x4"><label>4x4</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Ar Condicionado"><label>Ar Cond.</label></div>
                        <div class="cb-item"><input type="checkbox" name="item" value="Dire√ß√£o Hid./El√©t."><label>Dire√ß√£o</label></div>
                    </div>
                </div>

                <!-- OBSERVA√á√ïES -->
                <div class="section-title">üìù SERVI√áOS</div>
                <div class="row full">
                    <textarea id="observacoes" rows="5" placeholder="Descreva servi√ßos solicitados ou avarias..."></textarea>
                </div>

            </form>

            <!-- BOT√ïES -->
            <div class="btn-container hide-on-pdf">
                <button class="btn btn-primary" onclick="salvarLocal()">üíæ SALVAR</button>
                <button class="btn btn-pdf" id="btnGerarPDF" onclick="gerarPDF()">üìÑ BAIXAR PDF</button>
                <button class="btn btn-clear" onclick="limparForm()">üóëÔ∏è LIMPAR</button>
            </div>
        </div>

        <!-- CONTE√öDO: HIST√ìRICO -->
        <div id="tab-historico" class="tab-content content-area">
            <h3 style="margin-bottom:20px;">Hist√≥rico Local</h3>
            <div id="historico-lista"></div>
            <button class="btn btn-clear" style="margin-top:20px; width:100%;" onclick="limparHistoricoGeral()">Apagar Hist√≥rico</button>
        </div>
    </div>

    <script>
        // --- DATA HOJE ---
        document.getElementById('data_entrada').valueAsDate = new Date();

        // --- MONITOR STATUS ---
        function updateStatus() {
            const dot = document.getElementById('connectionDot');
            const txt = document.getElementById('connectionText');
            if(navigator.onLine) {
                dot.classList.remove('offline');
                txt.innerText = 'ONLINE';
            } else {
                dot.classList.add('offline');
                txt.innerText = 'OFFLINE';
            }
        }
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);

        // --- ABAS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'tab-historico') carregarHistorico();
        }

        // --- PDF FIX (CORRE√á√ÉO DE P√ÅGINA BRANCA) ---
        function gerarPDF() {
            const placa = document.getElementById('veiculo_placa').value || 'SEM-PLACA';
            const btn = document.getElementById('btnGerarPDF');
            
            // 1. Preparar visual
            btn.innerHTML = '‚è≥ Gerando...';
            document.body.classList.add('generating-pdf');
            window.scrollTo(0, 0); // For√ßa topo

            const element = document.getElementById('app');

            // 2. Configura√ß√µes para evitar erro de canvas
            const opt = {
                margin:       [5, 5, 5, 5],
                filename:     `Checklist_${placa.toUpperCase()}.pdf`,
                image:        { type: 'jpeg', quality: 0.95 }, // Qualidade um pouco menor ajuda no peso
                html2canvas:  { 
                    scale: 1.5, // Reduzido de 2 para 1.5 para evitar estouro de mem√≥ria/p√°g branca
                    scrollY: 0, 
                    useCORS: true,
                    logging: true // Ajuda a debugar se der erro
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };

            // 3. Gerar com delay para garantir renderiza√ß√£o
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    document.body.classList.remove('generating-pdf');
                    btn.innerHTML = 'üìÑ BAIXAR PDF';
                }).catch(err => {
                    console.error(err);
                    alert('Erro ao gerar PDF. Tente salvar e recarregar a p√°gina.');
                    document.body.classList.remove('generating-pdf');
                    btn.innerHTML = 'üìÑ BAIXAR PDF';
                });
            }, 500);
        }

        // --- L√ìGICA DE DADOS ---
        function salvarLocal() {
            const placa = document.getElementById('veiculo_placa').value;
            if(!placa) return alert('Preencha a PLACA');
            
            const dados = {
                id: Date.now(),
                placa: placa.toUpperCase(),
                cliente: document.getElementById('cliente_nome').value,
                modelo: document.getElementById('veiculo_modelo').value,
                data: new Date().toLocaleDateString('pt-BR'),
                json: colherDadosForm()
            };

            let db = JSON.parse(localStorage.getItem('volpini_v5') || '[]');
            db.unshift(dados);
            localStorage.setItem('volpini_v5', JSON.stringify(db));
            alert('Salvo!');
        }

        function colherDadosForm() {
            return {
                nome: document.getElementById('cliente_nome').value,
                tel: document.getElementById('cliente_tel').value,
                end: document.getElementById('cliente_end').value,
                placa: document.getElementById('veiculo_placa').value,
                modelo: document.getElementById('veiculo_modelo').value,
                km: document.getElementById('veiculo_km').value,
                comb: document.getElementById('veiculo_combustivel').value,
                data: document.getElementById('data_entrada').value,
                obs: document.getElementById('observacoes').value,
                itens: Array.from(document.querySelectorAll('input[name="item"]:checked')).map(i => i.value)
            };
        }

        function carregarHistorico() {
            const db = JSON.parse(localStorage.getItem('volpini_v5') || '[]');
            const lista = document.getElementById('historico-lista');
            if(!db.length) return lista.innerHTML = '<p>Vazio</p>';
            
            lista.innerHTML = db.map(i => `
                <div class="history-card">
                    <div><b>${i.placa}</b> - ${i.cliente} (${i.data})</div>
                    <button onclick="carregar(${i.id})">Abrir</button>
                </div>
            `).join('');
        }

        function carregar(id) {
            const db = JSON.parse(localStorage.getItem('volpini_v5') || '[]');
            const item = db.find(x => x.id === id);
            if(item) {
                const d = item.json;
                document.getElementById('cliente_nome').value = d.nome;
                document.getElementById('cliente_tel').value = d.tel;
                document.getElementById('cliente_end').value = d.end;
                document.getElementById('veiculo_placa').value = d.placa;
                document.getElementById('veiculo_modelo').value = d.modelo;
                document.getElementById('veiculo_km').value = d.km;
                document.getElementById('veiculo_combustivel').value = d.comb;
                document.getElementById('data_entrada').value = d.data;
                document.getElementById('observacoes').value = d.obs;
                
                document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
                d.itens.forEach(v => {
                    const el = document.querySelector(`input[value="${v}"]`);
                    if(el) el.checked = true;
                });
                
                switchTab('tab-novo');
                document.querySelectorAll('.tab-btn')[0].click();
            }
        }

        function limparForm() {
            document.getElementById('checklistForm').reset();
            document.getElementById('data_entrada').valueAsDate = new Date();
        }

        function limparHistoricoGeral() {
            if(confirm('Apagar tudo?')) {
                localStorage.removeItem('volpini_v5');
                carregarHistorico();
            }
        }
    </script>
</body>
</html>
